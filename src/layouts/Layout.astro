---
import Header from "@sections/Header/Header.astro";
import Footer from "@sections/Footer/Footer.astro";
import { SITE_CONFIG } from "@constants";
import type { SeoMeta } from "@/types";

interface Props extends SeoMeta {}

const {
  title,
  description = SITE_CONFIG.description,
  image = "/favicon.png",
  canonicalURL,
  noindex = false,
} = Astro.props;

// Safe URL handling
const siteUrl = Astro.site?.toString() || SITE_CONFIG.url;
const currentUrl = canonicalURL || `${siteUrl}${Astro.url.pathname}`;
const imageUrl = image.startsWith("http") ? image : `${siteUrl}${image}`;

// Generate structured data
const structuredData = {
  "@context": "https://schema.org",
  "@type": "Person",
  name: SITE_CONFIG.name,
  jobTitle: "Artist & Printmaker",
  description: SITE_CONFIG.description,
  url: siteUrl,
  sameAs: [],
  knowsAbout: [
    "Printmaking",
    "Ceramics",
    "Drawing",
    "Mixed Media",
    "Artist Books",
  ],
};
---

<!doctype html>
<html lang="en" prefix="og: http://ogp.me/ns#">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, shrink-to-fit=no"
    />
    <meta name="generator" content={Astro.generator} />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <!-- Primary Meta Tags -->
    <title>{title}</title>
    <meta name="title" content={title} />
    <meta name="description" content={description} />
    <meta name="author" content={SITE_CONFIG.author} />
    <meta name="keywords" content={SITE_CONFIG.keywords.join(", ")} />

    <!-- Robots -->
    {
      noindex ? (
        <meta name="robots" content="noindex, nofollow" />
      ) : (
        <meta name="robots" content="index, follow" />
      )
    }

    <!-- Canonical URL -->
    <link rel="canonical" href={currentUrl} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content={SITE_CONFIG.title} />
    <meta property="og:url" content={currentUrl} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={imageUrl} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta
      property="og:image:alt"
      content={`${SITE_CONFIG.name} - Contemporary Artist & Printmaker`}
    />
    <meta property="og:locale" content="en_GB" />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={currentUrl} />
    <meta property="twitter:title" content={title} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={imageUrl} />
    <meta
      property="twitter:image:alt"
      content={`${SITE_CONFIG.name} - Contemporary Artist & Printmaker`}
    />

    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png" />
    <link rel="icon" type="image/avif" sizes="32x32" href="/favicon.avif" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta name="theme-color" content="#000000" />

    <!-- Preconnect to external domains -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com" />

    <!-- Preload critical resources -->
    <link rel="preload" href="/styles/general.css" as="style" />
    <link
      rel="preload"
      href="/Exo2-VariableFont_wght.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />

    <!-- Styles -->
    <link rel="stylesheet" href="/styles/general.css" />

    <!-- Structured Data -->
    <script
      type="application/ld+json"
      is:inline
      set:html={JSON.stringify(structuredData)}
    />

    <!-- Scroll Reveal Animation -->
    <script src="../scripts/scroll-reveal.ts"></script>

    <!-- Performance & Security -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="format-detection" content="telephone=no" />
    <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  </head>

  <body
    class="flex flex-col items-center max-w-[2000px] mx-auto min-h-screen bg-white text-gray-900"
  >
    <!-- Skip to main content for accessibility -->
    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-black text-white px-4 py-2 z-50"
    >
      Skip to main content
    </a>

    <Header />

    <main id="main-content" class="flex-1 w-full" role="main">
      <slot />
    </main>

    <Footer />

    <!-- Performance monitoring (development only) -->
    <script is:inline>
      if (import.meta.env?.DEV && "performance" in window) {
        window.addEventListener("load", () => {
          const perfData = performance.getEntriesByType("navigation")[0];
          if (perfData?.loadEventEnd && perfData?.fetchStart) {
            console.log(
              "Page Load Time:",
              perfData.loadEventEnd - perfData.fetchStart,
            );
          }
        });
      }
    </script>
  </body>
</html>

<style is:global>
  /* Screen reader only utility */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  .sr-only:focus {
    position: static;
    width: auto;
    height: auto;
    padding: inherit;
    margin: inherit;
    overflow: visible;
    clip: auto;
    white-space: normal;
  }

  /* Smooth scrolling */
  html {
    scroll-behavior: smooth;
  }

  /* Focus styles for better accessibility */
  :focus {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
  }

  /* Print styles */
  @media print {
    body {
      max-width: none;
      margin: 0;
      padding: 1rem;
    }

    header,
    footer {
      display: none;
    }

    img {
      max-width: 100% !important;
      height: auto !important;
    }

    h1,
    h2,
    h3 {
      break-after: avoid;
    }

    a[href]:after {
      content: " (" attr(href) ")";
      font-size: 0.8em;
    }

    a[href^="#"]:after,
    a[href^="javascript:"]:after {
      content: "";
    }
  }

  /* High contrast mode support */
  @media (prefers-contrast: high) {
    body {
      background: white;
      color: black;
    }
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    html {
      scroll-behavior: auto;
    }

    *,
    *::before,
    *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
      scroll-behavior: auto !important;
    }
  }

  /* ===== VIEW TRANSITIONS ===== */
  @keyframes page-fade-out {
    from {
      opacity: 1;
      filter: blur(0);
    }
    to {
      opacity: 0;
      filter: blur(4px);
    }
  }

  @keyframes page-fade-in {
    from {
      opacity: 0;
      transform: translateY(12px);
      filter: blur(4px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
      filter: blur(0);
    }
  }

  ::view-transition-old(root) {
    animation: page-fade-out 0.25s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }

  ::view-transition-new(root) {
    animation: page-fade-in 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    animation-delay: 0.1s;
  }

  ::view-transition-old(header),
  ::view-transition-new(header) {
    animation: none;
    mix-blend-mode: normal;
  }

  ::view-transition-old(footer) {
    animation: page-fade-out 0.2s ease forwards;
  }

  ::view-transition-new(footer) {
    animation: page-fade-in 0.3s ease 0.15s forwards;
  }

  ::view-transition-group(header),
  ::view-transition-group(footer) {
    isolation: isolate;
  }

  ::view-transition-image-pair(root) {
    isolation: isolate;
  }
</style>
